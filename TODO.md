# devslot TODO

**重要**: このプロジェクトの開発は、Kent Beckが提唱しt-wadaが推奨する厳密なTDD（Red-Green-Refactor）により、堅牢なソフトウェアをインクリメンタルに構築していくこと。

## 現在の実装状況

### 完了済み
- ✅ Go moduleの初期化とkongのインストール
- ✅ 基本的なCLI構造とhelpコマンドの実装
- ✅ versionコマンドの実装 (-v/--version フラグ対応)
- ✅ boilerplateコマンドの実装
- ✅ 引数なしでhelpを表示する機能

### 未実装
- ❌ initコマンド
- ❌ createコマンド
- ❌ destroyコマンド
- ❌ reloadコマンド
- ❌ listコマンド
- ❌ doctorコマンド（優先度: 低）
- ❌ ロック機構

## 実装方針

### 1. 共通基盤の実装（優先度: 高）

#### 1.1 設定ファイル管理
- `devslot.yaml`の読み込み・パース機能
- YAMLパーサーライブラリの導入（github.com/goccy/go-yaml）
- 設定構造体の定義

#### 1.2 ロック機構
- `.devslot.lock`ファイルによる排他制御
- flock/fcntlを使用したファイルロック
- 各コマンド実行前のロック取得

#### 1.3 プロジェクトルート検出
- 現在のディレクトリから上位に向かって`devslot.yaml`を探索
- プロジェクトルートの環境変数設定

### 2. 各コマンドの実装順序

#### Phase 1: 基本的なリポジトリ管理
1. **initコマンド** (優先度: 高)
   - devslot.yamlの読み込み
   - リポジトリのbare clone
   - --allow-deleteオプションの実装
   - 進捗表示

2. **listコマンド** (優先度: 中)
   - slots/ディレクトリのスキャン
   - スロット名の一覧表示
   - 各スロットの状態確認

#### Phase 2: スロット管理
3. **createコマンド** (優先度: 高)
   - worktreeの作成
   - 環境変数の設定
   - post-createフックの実行
   - エラーハンドリング

4. **destroyコマンド** (優先度: 高)
   - pre-destroyフックの実行
   - worktreeの削除
   - ディレクトリのクリーンアップ

5. **reloadコマンド** (優先度: 高)
   - 既存worktreeの確認
   - 不足worktreeの追加
   - post-reloadフックの実行

#### Phase 3: 診断機能
6. **doctorコマンド** (優先度: 低)
   - プロジェクト構造の検証
   - リポジトリの整合性チェック
   - 修復可能な問題の自動修正
   - 詳細なレポート出力

## 技術的な考慮事項


### テスト戦略
- 各コマンドに対するユニットテスト（TDDで作成）
- 統合テスト（実際のgitリポジトリを使用）
- モックを使用した外部依存の分離
- テストヘルパー関数の作成

### エラーハンドリング
- 分かりやすいエラーメッセージ
- リトライ可能なエラーの識別
- ロールバック機能の実装

### パフォーマンス
- 大量のリポジトリに対するスケーラビリティ
- 並列処理の検討（goroutine）
- プログレスバーの表示

### 外部ライブラリ
- `github.com/goccy/go-yaml` - YAML処理（高速で標準ライブラリ互換）
- `github.com/schollz/progressbar/v3` - 進捗表示（オプション）
- 標準ライブラリを優先的に使用

## 次のステップ

1. **設定ファイル管理の実装**
   - YAMLパーサーの導入
   - devslot.yaml読み込み機能
   - テストの作成

2. **ロック機構の実装**
   - ファイルロックの実装
   - デッドロック対策
   - タイムアウト処理

3. **initコマンドの実装**
   - TDDアプローチの継続
   - git操作の抽象化
   - エラーケースの網羅

## コード品質の維持

- 各機能追加ごとのコミット・プッシュ
- コードレビューの実施
- ドキュメントの更新
- 一貫したエラーハンドリング
- 適切なログ出力

